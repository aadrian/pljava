<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2020-10-04 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PostgreSQL PL/Java &#x2013; Build situations that may need a linker runpath</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20201004" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean">
                                                <img src="../images/pljava_logo.jpg" alt="PL/Java logo combining the PostgreSQL elephant and a Java bean" />
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2020-10-04</span>
                  &nbsp;| <span id="projectVersion">Version: 1.5.6</span>
                      </div>
            <div class="xright">                    <a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a>
            |
                        <a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a>
            |
                        <a href="https://www.postgresql.org/list/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a>
            |
                        <a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Usage</h5>
                  <ul>
                  <li class="none">
                          <a href="../build/build.html" title="Building PL/Java">Building PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a>
            </li>
                  <li class="none">
                          <a href="../install/upgrade.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../use/use.html" title="User guide">User guide</a>
            </li>
                  <li class="none">
                          <a href="../develop/develop.html" title="Developer notes">Developer notes</a>
            </li>
          </ul>
                       <h5>Release Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../releasenotes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a>
            </li>
                  <li class="none">
                          <a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-deploy/index.html" title="PL/Java Deploy">PL/Java Deploy</a>
            </li>
                  <li class="none">
                          <a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a>
            </li>
                  <li class="none">
                          <a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a>
            </li>
                  <li class="none">
                          <a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <h1>Build situations that may need a linker <tt>runpath</tt></h1>
<p>In older PL/Java versions, it was common to build PL/Java with a <tt>RUNPATH</tt> embedded by the linker, so that it could find the Java library at run time. The configuration variable <tt>pljava.libjvm_location</tt> now takes care of locating Java, and in <i>most</i> cases, there is no longer any need to pass the linker a run path.</p>
<p>There are some exceptions, however, where it may still be useful to build PL/Java with a <tt>RUNPATH</tt> that matches the <tt>pg_config --libdir</tt> output.</p>
<div class="section">
<h2><a name="EnterpriseDB_PostgreSQL_distributions_that_bundle_system_libraries"></a>EnterpriseDB PostgreSQL distributions that bundle system libraries</h2>
<p>EnterpriseDB&#x2019;s pre-built distributions of PostgreSQL may include not only PostgreSQL&#x2019;s own libraries in the <tt>pg_config --libdir</tt> directory, but also specific versions of common system libraries. You are in this situation if you run <tt>ldd postgres</tt> and the list includes common system libraries like <tt>libxml2</tt>, <tt>libssl</tt>, <tt>libcrypto</tt>, <tt>libcom_err</tt>, <tt>libldap</tt>, etc., but shows them found in PostgreSQL&#x2019;s <tt>libdir</tt> instead of the standard system location, as in this example:</p>

<div class="source">
<div class="source">
<pre>$ ldd /u/pgsql/95/bin/postgres
...
libldap-2.4.so.2 =&gt; /u/pgsql/95/bin/../lib/libldap-2.4.so.2
...
</pre></div></div>
<p>In this case, if PL/Java is not built with a <tt>RUNPATH</tt>, it might find the system-provided versions of these standard libraries at run time, instead of the ones that came from EnterpriseDB. Signs of a problem include failure to load PL/Java, reporting <tt>undefined symbol</tt> errors <i>against standard system libraries</i>:</p>

<div class="source">
<div class="source">
<pre>=# CREATE EXTENSION pljava;
ERROR: could not load library ...:
/lib64/libldap_r-2.4.so.2: undefined symbol: ber_sockbuf_io_udp
</pre></div></div>
<p>If this is your situation, you can find the PostgreSQL <tt>libdir</tt> by running <tt>pg_config --libdir</tt>, and build PL/Java with a <tt>RUNPATH</tt> naming the same directory, as described below. <i>Note that if you do this, you lose the ability to install your built PL/Java on several systems with different PostgreSQL installed locations</i>.</p></div>
<div class="section">
<h2><a name="Building_PLJava_with_a_RUNPATH"></a>Building PL/Java with a <tt>RUNPATH</tt></h2>
<p>You can specify a <tt>RUNPATH</tt> by defining the <tt>pgsql.runpath</tt> property on the Maven command line. For example, if <tt>pg_config --libdir</tt> outputs <tt>/usr/lib/postgresql</tt>, add this to the <tt>mvn</tt> command:</p>

<div class="source">
<div class="source">
<pre>-Dpgsql.runpath=/usr/lib/postgresql
</pre></div></div>
<p>By default, this produces a linker option <tt>-Wl,-rpath=/usr/lib/postgresql</tt> which is the expected form for GNU linkers. If a different prefix is needed for your linker, it can be given as the <tt>pgsql.runpathpfx</tt> property:</p>

<div class="source">
<div class="source">
<pre>-Dpgsql.runpath=/usr/lib/postgresql -Dpgsql.runpathpfx=-Xfoo=
</pre></div></div>
<p>would place <tt>-Xfoo=/usr/lib/postgresql</tt> on the linker command line.</p>
<p>If these two properties are not flexible enough to produce the right options for your linker, you can directly add whatever options are necessary by editing <tt>pljava-so/pom.xml</tt>.</p>
<p><i>Note that building PL/Java with a <tt>RUNPATH</tt> forfeits the ability to use the the built PL/Java on several systems with different PostgreSQL installed locations</i>.</p></div>
<div class="section">
<h2><a name="Solving_the_same_problem_without_rebuilding_anything"></a>Solving the same problem without rebuilding anything</h2>
<p>If you have a situation where PL/Java is finding different libraries than came with PostgreSQL, but practical considerations weigh against rebuilding PL/Java (or you prefer to be able to use the same built PL/Java on several systems with different PostgreSQL installed locations), you can edit whatever script starts your PostgreSQL server to add an environment variable (<tt>LD_LIBRARY_PATH</tt> on Linux and typical Unices) to the server&#x2019;s environment, which all backend sessions will inherit. The variable should include the value shown by <tt>pg_config --libdir</tt>.</p>
<p>A restart of the server is needed for such a change to take effect.</p>
<p>Other platform-specific options for solving the same problem, such as <tt>ldconfig</tt> on Linux, may be available. Before there was <tt>pljava.libjvm_location</tt>, it used to be common to have to know these tricks. Now it should be uncommon, but in rare cases can still be useful.</p></div>
<div class="section">
<h2><a name="Other_situations_where_a_RUNPATH_may_be_needed"></a>Other situations where a RUNPATH may be needed</h2>
<p>On a system where several versions of PostgreSQL are installed, and one of them has been made the default, there may be entries in the standard system library directories that point to PostgreSQL-specific libraries (like <tt>libpgtypes</tt>, <tt>libpq</tt>, <tt>libecpg</tt>) <i>for the version selected as default</i>.</p>
<p>It is possible that when you load PL/Java into one of the non-default PostgreSQL installations, it will find the wrong versions of those libraries by looking in the system locations first.</p>
<p><i>This should only be possible if, for some reason, you needed the <tt>-Plinkpglibs</tt> option when building PL/Java.</i> Without that option, those PostgreSQL-specific libraries should be resolved within the PostgreSQL backend itself, where the correct versions will be found.</p>
<p>If your platform requires you to use <tt>-Plinkpglibs</tt>, and a problem with the wrong library versions being found at run time results, it also can be solved by explicitly using the <tt>pg_config --libdir</tt> value from the appropriate PostgreSQL version, using any of the methods described above.</p></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2003&#x2013;2020
                        <a href="http://tada.se/eng/">Tada AB</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
